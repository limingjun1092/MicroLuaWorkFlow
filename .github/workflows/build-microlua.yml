# .github/workflows/build-microlua.yml
name: Build MicroLua for RP2040

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake gcc-arm-none-eabi libnewlib-arm-none-eabi
        
    - name: Fix inttypes.h issue before build
      run: |
        # 修复 mlua.int64.c 文件
        find . -name "*.c" -type f -exec grep -l "PRId64\|PRIx64" {} \;
        
        # 如果找到了，手动添加头文件包含
        for file in $(find . -name "*.c" -type f -exec grep -l "PRId64\|PRIx64" {} \;) ; do
          echo "修复文件: $file"
          # 在包含 mlua/module.h 的行后添加 #include <inttypes.h>
          sed -i '/#include "mlua\/module.h"/a #include <inttypes.h>' "$file" 2>/dev/null || true
        done
        
    - name: Build MicroLua
      run: |
        mkdir -p build
        cd build
        # 只编译主目标，跳过测试
        cmake -DPICO_BOARD=pico \
              -DPICO_BUILD_PICOTOOL=OFF \
              -DBUILD_TESTING=OFF \
              -DCMAKE_C_FLAGS="-D__STDC_FORMAT_MACROS" ..
        make microlua -j4
        
    - name: Upload UF2 artifact
      uses: actions/upload-artifact@v4
      with:
        name: microlua-firmware
        path: build/microlua.uf2
